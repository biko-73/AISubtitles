name: Build and Release Enigma2 IPK

on:
  workflow_dispatch: {}   # يمكن تشغيله يدوياً من Actions
  release:
    types: [published]  # يبدأ تلقائياً عند إنشاء Release

jobs:
  build-ipk:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up IPK structure
      run: |
        mkdir -p ipk/CONTROL
        cp CONTROL/control ipk/CONTROL/
        mkdir -p ipk/usr/lib/enigma2/python/Plugins/Extensions/AISubtitles
        cp -r src/* ipk/usr/lib/enigma2/python/Plugins/Extensions/AISubtitles/

    - name: Build .ipk package
      run: |
        PKGNAME=$(awk '/^Package:/ {print $2}' ipk/CONTROL/control)
        VERSION=$(awk '/^Version:/ {print $2}' ipk/CONTROL/control)
        ARCH=$(awk '/^Architecture:/ {print $2}' ipk/CONTROL/control)
        tar czf ${PKGNAME}_${VERSION}_${ARCH}.ipk -C ipk .
        echo "Built IPK: ${PKGNAME}_${VERSION}_${ARCH}.ipk"

    - name: Upload IPK to Release
      uses: softprops/action-gh-release@v1
      with:
        files: "${{ github.workspace }}/*.ipk"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
